<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf AI - Value Picks</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, createElement: e } = React;

        function GolfAI() {
            const [activeTab, setActiveTab] = useState('setup');
            const [apiKey, setApiKey] = useState('');
            const [apiKeyStored, setApiKeyStored] = useState(false);
            const [error, setError] = useState('');
            const [predictions, setPredictions] = useState(null);
            const [predictionsLoading, setPredictionsLoading] = useState(false);
            const [selectedTour, setSelectedTour] = useState('pga');
            const [timestamps, setTimestamps] = useState({});
            const CACHE_DURATION = 12 * 60 * 60 * 1000;

            const getToday = () => {
                const now = new Date();
                return now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };

            useEffect(() => {
                const stored = localStorage.getItem('anthropic_api_key');
                if (stored) {
                    setApiKey(stored);
                    setApiKeyStored(true);
                    setActiveTab('predictions');
                }
                loadCachedData();
            }, []);

            const loadCachedData = () => {
                try {
                    const predCache = localStorage.getItem('cached_predictions');
                    if (predCache) {
                        const parsed = JSON.parse(predCache);
                        const now = Date.now();
                        if (now - parsed.timestamp < CACHE_DURATION) {
                            setPredictions(parsed.data);
                            setSelectedTour(parsed.tour || 'pga');
                            setTimestamps(prev => ({...prev, [`pred_${parsed.tour}`]: parsed.timestamp}));
                        }
                    }
                } catch (err) {
                    console.error('Cache error:', err);
                }
            };

            const saveApiKey = () => {
                if (apiKey.trim()) {
                    localStorage.setItem('anthropic_api_key', apiKey.trim());
                    setApiKeyStored(true);
                    setActiveTab('predictions');
                    setError('');
                } else {
                    setError('Please enter a valid API key');
                }
            };

            const clearApiKey = () => {
                if (confirm('Clear API key and cache?')) {
                    localStorage.clear();
                    setApiKey('');
                    setApiKeyStored(false);
                    setActiveTab('setup');
                    setPredictions(null);
                    setTimestamps({});
                }
            };

            const extractJSON = (text) => {
                try {
                    let cleaned = text.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                    const start = cleaned.indexOf('{');
                    const end = cleaned.lastIndexOf('}');
                    if (start === -1 || end === -1) throw new Error('No JSON found');
                    const jsonStr = cleaned.substring(start, end + 1);
                    const parsed = JSON.parse(jsonStr);
                    if (!parsed.valuePicks) throw new Error('Invalid structure');
                    return parsed;
                } catch (err) {
                    throw new Error('Failed to parse response');
                }
            };

            const callAPI = async (messages, maxTokens = 1500) => {
                const response = await fetch("/.netlify/functions/claude", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        api_key: apiKey,
                        max_tokens: maxTokens,
                        messages: messages,
                        tools: ['web_search']
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Error ${response.status}`);
                }
                return await response.json();
            };

            const shouldShowPredictions = () => {
                const day = new Date().getDay();
                return day >= 3 || day === 0;
            };

            const fetchPredictions = async (tour) => {
                if (!shouldShowPredictions()) {
                    setPredictions({ comeSoonMessage: true });
                    return;
                }
                
                const cacheKey = `pred_${tour}`;
                if (timestamps[cacheKey] && Date.now() - timestamps[cacheKey] < CACHE_DURATION) {
                    return;
                }

                setPredictionsLoading(true);
                setError('');
                setPredictions(null);

                try {
                    const tourName = tour === 'pga' ? 'PGA Tour' : 'DP World Tour';
                    const tourSite = tour === 'pga' ? 'espn.com/golf' : 'golfdigest.com';
                    const today = getToday();
                    
                    const data = await callAPI([{
                        role: "user",
                        content: `${today}. ${tourName} this week.

Search ${tourSite} for tournament name, course, location, dates.
Search draftkings.com for current golf odds.

Use your golf knowledge for player stats.

2 value picks 20/1+ odds.

JSON:
{"tournament":"","course":"","location":"","dates":"","courseProfile":{"length":"","par":"","keyFeatures":[""],"favoredSkills":[""]},"weather":"","valuePicks":[{"rank":1,"player":"","odds":"","why":"","coursefit":"","stats":{"drivingAcc":"","gir":"","sgApproach":"","sgPutting":"","recentForm":""}},{"rank":2,"player":"","odds":"","why":"","coursefit":"","stats":{"drivingAcc":"","gir":"","sgApproach":"","sgPutting":"","recentForm":""}}]}`
                    }]);

                    const text = data.content.filter(i => i.type === "text").map(i => i.text).join("");
                    const json = extractJSON(text);
                    json.topPicks = json.valuePicks;
                    setPredictions(json);
                    
                    const ts = Date.now();
                    setTimestamps(prev => ({...prev, [cacheKey]: ts}));
                    localStorage.setItem('cached_predictions', JSON.stringify({ data: json, tour, timestamp: ts }));
                } catch (err) {
                    console.error('Error:', err);
                    setError(err.message || 'Failed to load predictions');
                } finally {
                    setPredictionsLoading(false);
                }
            };

            const getCacheAge = (key) => {
                if (!timestamps[key]) return null;
                const age = Date.now() - timestamps[key];
                const hours = Math.floor(age / (60 * 60 * 1000));
                const minutes = Math.floor((age % (60 * 60 * 1000)) / (60 * 1000));
                return hours > 0 ? `${hours}h ${minutes}m ago` : `${minutes}m ago`;
            };

            // Main render
            return e('div', { className: 'min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-3 sm:p-6' },
                e('div', { className: 'max-w-6xl mx-auto' },
                    // Header
                    e('div', { className: 'bg-white rounded-lg shadow-lg p-4 sm:p-6 mb-4' },
                        e('div', { className: 'flex items-center justify-between' },
                            e('div', { className: 'flex items-center gap-3' },
                                e('div', { className: 'w-12 h-12 bg-green-600 rounded-full flex items-center justify-center text-white text-2xl' }, 'â›³'),
                                e('div', null,
                                    e('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Golf AI'),
                                    e('p', { className: 'text-base text-gray-600' }, 'Value Picks & Analysis')
                                )
                            ),
                            apiKeyStored && e('button', { onClick: clearApiKey, className: 'px-3 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700' }, 'Clear')
                        )
                    ),
                    
                    // Error message
                    error && e('div', { className: 'bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg mb-4 text-sm' }, error),
                    
                    // Setup tab
                    activeTab === 'setup' && e('div', { className: 'bg-white rounded-lg shadow-lg p-8' },
                        e('h2', { className: 'text-2xl font-bold mb-4' }, 'ðŸ”‘ API Key'),
                        e('div', { className: 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4' },
                            e('p', { className: 'text-sm text-blue-800 mb-2' }, 'Get your Anthropic API key:'),
                            e('p', { className: 'text-sm text-blue-800' }, '1. Visit console.anthropic.com'),
                            e('p', { className: 'text-sm text-blue-800' }, '2. API Keys â†’ Create Key'),
                            e('p', { className: 'text-sm text-blue-800' }, '3. Paste below')
                        ),
                        e('input', {
                            type: 'password',
                            value: apiKey,
                            onChange: (ev) => setApiKey(ev.target.value),
                            onKeyPress: (ev) => ev.key === 'Enter' && saveApiKey(),
                            placeholder: 'sk-ant-...',
                            className: 'w-full px-3 py-2 border rounded-lg mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-green-500'
                        }),
                        e('button', {
                            onClick: saveApiKey,
                            className: 'w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700'
                        }, 'Save & Continue')
                    ),
                    
                    // Predictions tab
                    activeTab === 'predictions' && apiKeyStored && e('div', null,
                        // Tour selector
                        e('div', { className: 'bg-white rounded-lg shadow-lg p-3 mb-4' },
                            e('div', { className: 'flex gap-2' },
                                e('button', {
                                    onClick: () => setSelectedTour('pga'),
                                    className: `flex-1 px-4 py-2 rounded-lg font-semibold text-sm ${selectedTour === 'pga' ? 'bg-green-600 text-white' : 'bg-gray-200'}`
                                }, 'PGA Tour'),
                                e('button', {
                                    onClick: () => setSelectedTour('dp'),
                                    className: `flex-1 px-4 py-2 rounded-lg font-semibold text-sm ${selectedTour === 'dp' ? 'bg-green-600 text-white' : 'bg-gray-200'}`
                                }, 'DP World Tour')
                            )
                        ),
                        
                        // Load button
                        !predictions && !predictionsLoading && e('div', { className: 'bg-white rounded-lg shadow-lg p-8 text-center' },
                            e('div', { className: 'text-6xl mb-4' }, 'ðŸŽ¯'),
                            e('h2', { className: 'text-2xl font-bold mb-3' }, `${selectedTour === 'pga' ? 'PGA Tour' : 'DP World Tour'} Value Picks`),
                            e('p', { className: 'text-sm text-gray-500 mb-6' }, 'AI-powered betting intelligence â€¢ Top 2 picks'),
                            e('button', {
                                onClick: () => fetchPredictions(selectedTour),
                                className: 'px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700'
                            }, 'Load Predictions')
                        ),
                        
                        // Loading
                        predictionsLoading && e('div', { className: 'bg-white rounded-lg shadow-lg p-8 text-center' },
                            e('div', { className: 'inline-block animate-spin rounded-full h-10 w-10 border-b-2 border-green-600' }),
                            e('p', { className: 'text-sm text-gray-600 mt-4' }, 'Loading tournament & odds...'),
                            e('p', { className: 'text-xs text-gray-500 mt-2' }, 'âš¡ 10-15 seconds')
                        ),
                        
                        // Coming soon
                        !predictionsLoading && predictions?.comeSoonMessage && e('div', { className: 'bg-white rounded-lg shadow-lg p-8 text-center' },
                            e('div', { className: 'text-6xl mb-4' }, 'â›³'),
                            e('h2', { className: 'text-2xl font-bold mb-3' }, 'Coming Wednesday'),
                            e('p', { className: 'text-gray-600' }, 'Value picks available Wednesday - Sunday')
                        ),
                        
                        // Results
                        !predictionsLoading && predictions && !predictions.comeSoonMessage && e('div', { className: 'bg-white rounded-lg shadow-lg p-4' },
                            e('h2', { className: 'text-xl font-bold mb-2' }, predictions.tournament || 'Tournament'),
                            e('p', { className: 'text-sm text-gray-600 mb-4' }, predictions.course || 'Course'),
                            e('button', {
                                onClick: () => fetchPredictions(selectedTour),
                                disabled: predictionsLoading,
                                className: 'px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 disabled:opacity-50 mb-4'
                            }, 'Refresh'),
                            predictions.topPicks?.map((pick, i) =>
                                e('div', { key: i, className: 'border-l-4 border-green-600 bg-gray-50 p-3 rounded-r-lg mb-3' },
                                    e('div', { className: 'flex justify-between mb-2' },
                                        e('h3', { className: 'text-base font-bold' }, `${pick.rank}. ${pick.player}`),
                                        e('span', { className: 'px-3 py-1 bg-green-600 text-white rounded-full text-sm font-bold' }, pick.odds)
                                    ),
                                    e('p', { className: 'text-sm text-gray-700' }, pick.why)
                                )
                            )
                        )
                    ),
                    
                    // Footer
                    e('div', { className: 'mt-6 text-center text-xs text-gray-600' },
                        e('p', null, 'Powered by Claude AI â€¢ ESPN Golf â€¢ DraftKings')
                    )
                )
            );
        }

        ReactDOM.render(React.createElement(GolfAI), document.getElementById('root'));
    </script>
</body>
</html>
