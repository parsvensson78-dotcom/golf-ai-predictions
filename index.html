const fetchPredictions = async (tour) => {
    setPredictionsLoading(true);
    setError('');

    try {
        const tourName = tour === 'pga' ? 'PGA Tour' : 'DP World Tour';
        
        const data = await callClaudeAPI([
            {
                role: "user",
                content: `Search for this week's ${tourName} tournament (Thursday-Sunday).

Find: tournament, course, field, conditions, odds.

Pick 10 players FROM THE FIELD based on stats and course fit.

Return ONLY this JSON structure with no extra text:
{"tournament":"Tournament Name","course":"Course Name","location":"City, Country","dates":"Jan XX-XX","courseAnalysis":{"type":"links","length":"7000 yards","par":"72","conditions":"windy, firm","keyFactors":["driving","wind play"]},"topPicks":[{"rank":1,"player":"Player Name","odds":"10-1","reasoning":"Good driver, plays well in wind","keyStrengths":["driving distance","wind"],"confidence":"high"}]}

Include all 10 players with ranks 1-10.`
            }
        ], 1800);

        const fullResponse = data.content
            .map(item => (item.type === "text" ? item.text : ""))
            .filter(Boolean)
            .join("\n");

        let cleanResponse = fullResponse.replace(/```json\n?|\n?```/g, "").trim();
        
        const jsonStart = cleanResponse.indexOf('{');
        if (jsonStart > 0) {
            cleanResponse = cleanResponse.substring(jsonStart);
        }
        
        const jsonEnd = cleanResponse.lastIndexOf('}');
        if (jsonEnd > 0) {
            cleanResponse = cleanResponse.substring(0, jsonEnd + 1);
        }
        
        let predictionsData;
        try {
            predictionsData = JSON.parse(cleanResponse);
        } catch (parseError) {
            console.error('JSON parse failed:', parseError);
            console.error('Attempted to parse:', cleanResponse);
            throw new Error('Invalid response format. Click refresh to try again.');
        }
        
        setPredictions(predictionsData);
    } catch (err) {
        console.error("Error:", err);
        setError(`${err.message} - Try refreshing.`);
    } finally {
        setPredictionsLoading(false);
    }
};
